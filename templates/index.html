<!DOCTYPE html>
<html>
<head>
    <title>Bedtime Streamer</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 20px; }
        .movie-card { background: #1e1e1e; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        select, input { padding: 8px; margin: 5px 0; }
        .status { color: #00ff00; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ðŸŽ¬ Bedtime Streamer</h1>
    <div id="status-area"></div>
    <div id="library">Loading movies...</div>

    <script>
        async function loadLibrary() {
            const res = await fetch('/api/library');
            const movies = await res.json();
            const container = document.getElementById('library');
            container.innerHTML = '';

            movies.forEach((movie, index) => { // Added index for unique IDs
                const div = document.createElement('div');
                div.className = 'movie-card';
                
                let subHtml = '';
                const safeId = "movie-" + index; // Safe ID for elements
                const hasSubs = movie.metadata.has_internal_subs
                const subIndex = movie.metadata.text_sub_index

                if (movie.local_subs && movie.local_subs.length > 0) {
                    subHtml = `<label>Sidecar Subs:</label>
                            <select id="sub-${safeId}">
                                <option value="">None / Use Internal</option>`;
                    movie.local_subs.forEach(sub => {
                        subHtml += `<option value="${sub.path.replace(/\\/g, '/')}">${sub.name}</option>`;
                    });
                    subHtml += `</select>`;
                } else {
                    subHtml = hasSubs
                        ? '<span style="color: #aaa;">(Internal Subs Detected)</span><input type="hidden" id="sub-'+safeId+'" value="">' 
                        : '<input type="text" placeholder="Manual .srt path" id="sub-'+safeId+'">';
                }

                div.innerHTML = `
                    <h3>${movie.title}</h3>
                    <p>Codec: ${movie.metadata.codec} | Res: ${movie.metadata.resolution}</p>
                    <div style="margin-bottom:10px;">${subHtml}</div>
                    <select id="preset-${safeId}">
                        <option value="cpu_fast">CPU (Very Fast)</option>
                        <option value="gpu_nvenc">GPU (NVIDIA NVENC)</option>
                        <option value="gpu_nvenc_high_quality">GPU (High Quality)</option>
                    </select>
                    <button onclick="startStream('${movie.full_path.replace(/\\/g, '/')}',
                    '${movie.title}', ${hasSubs}, ${subIndex}, '${safeId}')">Start Stream</button>
                    <button style="background:red" onclick="stopStream()">Stop</button>
                `;
                container.appendChild(div);
            });
        }

        async function startStream(path, title, hasInternalSubs, textSubIndex, safeId) {
            const preset = document.getElementById('preset-' + safeId).value;
            const subInput = document.getElementById('sub-' + safeId);
            const sub_path = subInput ? subInput.value : null;

            const res = await fetch('/api/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    path: path, 
                    preset: preset, 
                    sub_path: sub_path,
                    has_internal_subs: hasInternalSubs,
                    text_sub_index: textSubIndex 
                })
            });
            const data = await res.json();
            document.getElementById('status-area').innerHTML = `<span class="status">Streaming: ${title}</span>`;
        }

        async function stopStream() {
            await fetch('/api/stop', { method: 'POST' });
            document.getElementById('status-area').innerText = "Stopped.";
        }

        loadLibrary();
    </script>
</body>
</html>